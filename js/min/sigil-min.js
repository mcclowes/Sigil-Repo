$(function(){function update_variable_display(){$("#cards_to_play").text(cards_to_play),$("#damagingA").text(damagingA),$("#damagingE").text(damagingE),$("#damagingS").text(damagingS),$("#destroyingA").text(destroyingA),$("#destroyingE").text(destroyingE),$("#destroyingS").text(destroyingS),$("#discarding").text(discarding),$("#shielding").text(shielding),$("#deshielding").text(deshielding),$("#freezing").text(freezing),$("#thawing").text(thawing),$("#blocking").text(blocking)}function update_grid_display(){for(var e=0;4>e;e++)for(var t=0;4>t;t++)$("#grid_box_"+e+"_"+t).text(global_board.results[e][t])}function shuffle(e){for(var t,s,i=e.length;i;t=Math.floor(Math.random()*i),s=e[--i],e[i]=e[t],e[t]=s);return e}function Card(){this.cardName="",this.cardEffects=[],this.cardImage="",this.cardBody="",this.playCard=function(targetCard,playerNo,board){if(window.console.log($(this)),cards_to_play>0){$(this.cardBody).fadeOut(300);for(var deal=new RegExp("^deal$","i"),destroy=new RegExp("^destroy$|^remove$","i"),draw=new RegExp("^draw$","i"),one=new RegExp("^a$|^1$","i"),every=new RegExp("^all$|^every$","i"),endTurn=new RegExp("^end$","i"),targetSelf=new RegExp("^your$","i"),targetEnemy=new RegExp("^enemy$","i"),freeze=new RegExp("^freeze$","i"),thaw=new RegExp("^thaw$","i"),shield=new RegExp("^shield$|^shields$","i"),block=new RegExp("^block$","i"),i=0;i<this.cardEffects.length;i++){window.console.log(this.cardName+" -> "+this.cardEffects[i]);var effect=this.cardEffects[i].split(" ");if(window.console.log(effect),effect[0]&&effect[0].match(endTurn))window.console.log("End turn"),global_board.endTurn();else if(effect[0]&&effect[0].match(deal))effect[1]&&effect[1].match(one)?effect[4]&&effect[4].match(targetSelf)?(window.console.log("Target self"),damagingS=1):effect[4]&&effect[4].match(targetEnemy)?(window.console.log("Target enemy"),damagingE=1):damagingA=1:effect[1]&&effect[1].match(every)||(effect[4]&&effect[4].match(targetSelf)?(window.console.log("Target self"),damagingS=effect[1]):effect[4]&&effect[4].match(targetEnemy)?(window.console.log("Target enemy"),damagingE=effect[1]):damagingA=effect[1]);else if(effect[0]&&effect[0].match(destroy))if(effect[2]&&effect[2].match(shield))if(effect[1]&&effect[1].match(one))window.console.log("deshield 1"),deshielding=1;else if(effect[1]&&effect[1].match(every)){window.console.log("Unshielding all!");for(var i=0;4>i;i++)for(var j=0;4>j;j++)0===board.results[i][j]&&(board.shield[i][j]=0)}else window.console.log("deshield lots"),deshielding=effect[1];else if(effect[1]&&effect[1].match(one))effect[4]&&effect[4].match(targetSelf)?window.console.log("Target self"):effect[4]&&effect[4].match(targetEnemy)?(window.console.log("Target enemy"),damagingE=1):(window.console.log("Destroying one piece"),destroyingA=1);else if(effect[1]&&effect[1].match(every)){window.console.log("Destroy all pieces");var pieces=$(".box.flipper");$(pieces).removeClass("flip"),$(pieces).removeClass("opened"),$(pieces).removeClass("opened-p1"),$(pieces).removeClass("opened-p2");for(var i=0;4>i;i++)for(var j=0;4>j;j++)board.results[i][j]=0}else effect[4]&&effect[4].match(targetSelf)?(window.console.log("Target self"),destroyingS=effect[1]):effect[4]&&effect[4].match(targetEnemy)?(window.console.log("Target enemy"),destroyingE=effect[1]):destroyingA=effect[1];else if(effect[0]&&effect[0].match(draw))if(effect[1]&&effect[1].match(one))eval("player"+playerNo).hand.length<maxHandSize&&eval("player"+playerNo).drawCard();else for(var i=0;i<effect[1];i++)eval("player"+playerNo).hand.length<maxHandSize&&eval("player"+playerNo).drawCard();else if(effect[0]&&effect[0].match(freeze))if(window.console.log(effect[1]),window.console.log(effect[1].match(one)),effect[1]&&effect[1].match(one))window.console.log("Doing a single frost... spoopy!"),freezing=1;else if(effect[1]&&effect[1].match(every)){window.console.log("Freezing all!");for(var i=0;4>i;i++)for(var j=0;4>j;j++)0===board.results[i][j]&&(board.frost[i][j]=2,$(".box.flipper").addClass("frost2"))}else freezing=effect[1];else if(effect[0]&&effect[0].match(thaw))if(effect[1]&&effect[1].match(one))window.console.log("Doing a shield"),thawing=1;else if(effect[1]&&effect[1].match(every)){window.console.log("Freezing all!");for(var i=0;4>i;i++)for(var j=0;4>j;j++)0===board.results[i][j]&&(board.frost[i][j]=0)}else thawing=effect[1];else if(effect[0]&&effect[0].match(shield))if(effect[1]&&effect[1].match(one))window.console.log("Doing a shield"),shielding=1;else if(effect[1]&&effect[1].match(every)){window.console.log("Freezing all!");for(var i=0;4>i;i++)for(var j=0;4>j;j++)0===board.results[i][j]&&(board.shields[i][j]=1)}else shielding=effect[1];else effect[0]&&effect[0].match(discarding);cards_to_play-=1,update_variable_display(),update_grid_display()}window.console.log("DaE: "+damagingE+", DaS: "+damagingS+", DeE: "+destroyingE+", DeS: "+destroyingS+", Sh: "+shielding+", Fr: "+freezing+", Bl: "+blocking),this.cardBody.remove(),delete this}else window.alert("No more cards can be played this turn")},this.createCard=function(e){this.cardBody=jQuery("<div/>",{"class":"card drawn "+this.cardName.toLowerCase().split(" ").join("_")}),jQuery("<div/>",{"class":"cardName",text:this.cardName}).appendTo(this.cardBody),jQuery("<div/>",{"class":"cardEffects",text:this.cardEffects.join([separator=". "])+"."}).appendTo(this.cardBody);var t=this;$(this.cardBody[0]).click(function(){t.playCard(t,e,b)}),$(".p"+e+"-hand:first").append(this.cardBody)}}function Piece(){this.row=-1,this.col=-1,this.shielded=!1}function Player(number){this.playerNo=number,this.deck=[],this.hand=[],this.active=[],this.discard=[],this.pieces=[],this.createDeck=function(){for(var tempDeck=JSON.parse(eval("deck_p"+this.playerNo)),i=0;i<tempDeck.length;i++){var newCard=new Card;newCard.cardName=tempDeck[i];for(var j=0;j<cards.length;j++)cards[j].name===newCard.cardName&&(newCard.cardEffects=cards[j].effects);this.deck.push(newCard)}this.deck=shuffle(this.deck)},this.drawCard=function(){this.deck.length>0&&this.hand.length<maxHandSize&&(this.deck[0].createCard(this.playerNo),this.hand.push(this.deck[0]),this.deck.splice(0,1),$(".hand").append())}}function Board(){this.results=[],this.frost=[],this.rock=[],this.shields=[],this.currentPlayer=0,this.initiateBoard=function(){for(var e=0;4>e;e++){this.results[e]=[],this.frost[e]=[],this.rock[e]=[],this.shields[e]=[];for(var t=0;4>t;t++){var s=4*e+t+1;this.results[e][t]=0,this.frost[e][t]=0,this.rock[e][t]=0,this.shields[e][t]=0}}this.currentPlayer=1},this.endTurn=function(){if(1===this.currentPlayer){this.currentPlayer=-1,$(".wrapper").removeClass("p1-turn"),$(".wrapper").addClass("p2-turn");for(var e=0;e<player1.hand.length;e++)player1.hand[e].cardBody.addClass("hidden");for(var e=0;e<player2.hand.length;e++)player2.hand[e].cardBody.removeClass("hidden");player2.drawCard()}else{this.currentPlayer=1,$(".wrapper").removeClass("p2-turn"),$(".wrapper").addClass("p1-turn");for(var e=0;e<player2.hand.length;e++)player2.hand[e].cardBody.addClass("hidden");for(var e=0;e<player1.hand.length;e++)player1.hand[e].cardBody.removeClass("hidden");player1.drawCard()}for(var e=0;4>e;e++)for(var t=0;4>t;t++)1===this.frost[e][t]&&(this.frost[e][t]=0,target=$('div[x="'+e+'"][y="'+t+'"]:first'),target.removeClass("frost1")),2===this.frost[e][t]&&(this.frost[e][t]=1,target=$('div[x="'+e+'"][y="'+t+'"]:first'),target.removeClass("frost2"),target.addClass("frost1"));cards_to_play=1,damagingA=0,damagingE=0,damagingS=0,destroyingA=0,destroyingE=0,destroyingS=0,discarding=0,shielding=0,deshielding=0,freezing=0,thawing=0,blocking=0,update_variable_display()},this.updateCell=function(e,t){if(window.console.log("Clicked on "+this+"/"+$(this)),0!==this.results[e][t]||this.frost[e][t]>=1||this.rock[e][t]>=1)window.console.log("The cell is occupied!"),0!==this.results[e][t]?(destroyingA>0&&(window.console.log("Destroying any piece"),this.results[e][t]=0,window.console.log(this.results),target=$('div[x="'+e+'"][y="'+t+'"]:first'),$(target).removeClass("flip"),$(target).removeClass("opened"),$(target).removeClass("opened-p1"),$(target).removeClass("opened-p2"),destroyingA-=1),destroyingE>0?this.results[e][t]!==this.currentPlayer&&(window.console.log("Destroying an enemy"),this.results[e][t]=0,window.console.log(this.results),target=$('div[x="'+e+'"][y="'+t+'"]:first'),$(target).removeClass("flip"),$(target).removeClass("opened"),$(target).removeClass("opened-p1"),$(target).removeClass("opened-p2"),destroyingE-=1):destroyingS>0?this.results[e][t]===this.currentPlayer&&(window.console.log("Destroying own piece"),this.results[e][t]=0,window.console.log(this.results),target=$('div[x="'+e+'"][y="'+t+'"]:first'),$(target).removeClass("flip"),$(target).removeClass("opened"),$(target).removeClass("opened-p1"),$(target).removeClass("opened-p2"),destroyingS-=1):damagingA>0?(window.console.log("Damaging any"),this.results[e][t]=0,window.console.log(this.results),target=$('div[x="'+e+'"][y="'+t+'"]:first'),$(target).removeClass("flip"),$(target).removeClass("opened"),$(target).removeClass("opened-p1"),$(target).removeClass("opened-p2"),damagingA-=1):damagingE>0?this.results[e][t]!==this.currentPlayer&&(window.console.log("Damaging enemy"),this.results[e][t]=0,window.console.log(this.results),target=$('div[x="'+e+'"][y="'+t+'"]:first'),$(target).removeClass("flip"),$(target).removeClass("opened"),$(target).removeClass("opened-p1"),$(target).removeClass("opened-p2"),damagingE-=1):damagingS>0?this.results[e][t]===this.currentPlayer&&(window.console.log("Damaging own piece"),this.results[e][t]=0,window.console.log(this.results),target=$('div[x="'+e+'"][y="'+t+'"]:first'),$(target).removeClass("flip"),$(target).removeClass("opened"),$(target).removeClass("opened-p1"),$(target).removeClass("opened-p2"),damagingS-=1):shielding>0?shielding-=1:deshielding>0&&(deshielding-=1)):this.frost[e][t]>=1&&thawing>0?(window.console.log("Thawing out a square"),target=$('div[x="'+e+'"][y="'+t+'"]:first'),$(target).removeClass("frost1"),$(target).removeClass("frost2")):this.rock[e][t]>=1&&deblocking>0;else if(freezing>0)this.frost[e][t]=2,target=$('div[x="'+e+'"][y="'+t+'"]:first'),target.addClass("frost2"),freezing-=1;else if(blocking>0)board.rock[e][t]=3,target=$('div[x="'+e+'"][y="'+t+'"]:first'),target.addClass("frost2"),blocking-=1;else{var s=new Piece;s.row=e,s.col=t,s.square=$("div").find("[x="+e+"][y="+t+"]"),this.results[e][t]=this.currentPlayer,s.square.addClass("opened flip"),1===this.currentPlayer?(s.square.addClass("opened-p1"),$(player1.pieces).append(s)):(s.square.addClass("opened-p2"),$(player2.pieces).append(s)),this.endTurn()}update_variable_display(),update_grid_display()},this.drawMark=function(e){return 1===e?"X":"O"},this.playGame=function(e,t){window.console.log("playing"),void 0===this.determineWinner()&&this.updateCell(e,t),this.gameOver()},this.gameOver=function(){var e=this;void 0!==this.determineWinner()&&setTimeout(function(){window.alert("The winner is "+e.drawMark(e.determineWinner()))},100)},this.determineWinner=function(){return void 0!==this.checkRows()?this.checkRows():void 0!==this.checkCols()?this.checkCols():void 0!==this.checkDiagonals()?this.checkDiagonals():void 0},this.checkRows=function(){for(var e=0;4>e;e++){var t=this.results[e][0]+this.results[e][1]+this.results[e][2]+this.results[e][3];if(4===t||-4===t)return this.results[e][0]}},this.checkCols=function(){for(var e=0;4>e;e++){var t=this.results[0][e]+this.results[1][e]+this.results[2][e]+this.results[3][e];if(4===t||-4===t)return this.results[0][e]}},this.checkDiagonals=function(){var e=this.results[0][0]+this.results[1][1]+this.results[2][2]+this.results[3][3];return 4===e||-4===e?this.results[1][1]:(e=this.results[0][3]+this.results[1][2]+this.results[2][1]+this.results[3][0],4===e||-4===e?this.results[1][1]:void 0)}}var startHandSize=2,maxHandSize=10,cards_to_play=1;damagingA=0,damagingE=0,damagingS=0,destroyingA=0,destroyingE=0,destroyingS=0,discarding=0,shielding=0,deshielding=0,freezing=0,thawing=0,blocking=0;var global_board,b=new Board;b.initiateBoard(),global_board=b;var player1=new Player(1),player2=new Player(2);player1.createDeck(),player2.createDeck(),update_variable_display(),update_grid_display();for(var i=0;startHandSize>i;i++)player1.drawCard();for(var i=0;startHandSize>i;i++)player2.drawCard();for(var i=0;i<player2.hand.length;i++)player2.hand[i].cardBody.addClass("hidden");$(".box").click(function(){var e=this.getAttribute("x"),t=this.getAttribute("y");b.playGame(e,t)}),$("#submitButton").click(function(){location.reload()}),$("#endTurnButton").click(function(){b.endTurn()})});