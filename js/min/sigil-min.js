$(function(){function shuffle(e){for(var t,s,r=e.length;r;t=Math.floor(Math.random()*r),s=e[--r],e[r]=e[t],e[t]=s);return e}function Card(){this.cardName="",this.cardEffects=[],this.cardImage="",this.cardBody="",this.playCard=function(targetCard,playerNo,board){function setupPlay(){window.console.log("Restoring piece placements"),$(".box.flipper:not(.opened)").click(function(){var e=this.getAttribute("x"),t=this.getAttribute("y");board.playGame(e,t)})}window.console.log($(this)),$(this.cardBody).fadeOut(300);for(var deal=new RegExp("deal","i"),destroy=new RegExp("destroy","i"),draw=new RegExp("draw","i"),one=new RegExp("a|1","i"),every=new RegExp("all|every","i"),endTurn=new RegExp("end","i"),targetSelf=new RegExp("your","i"),freeze=new RegExp("freeze","i"),block=new RegExp("block","i"),i=0;i<this.cardEffects.length;i++){window.console.log(this.cardName+" -> "+this.cardEffects[i]);var effect=this.cardEffects[i].split(" ");if(window.console.log(effect),effect[0]&&effect[0].match(endTurn))board.endTurn();else if(effect[0]&&effect[0].match(deal))effect[1]&&effect[1].match(one)?effect[4]&&effect[4].match(targetSelf)?(window.console.log("Target self"),damagingS=1):damagingE=1:effect[1]&&effect[1].match(every)||(effect[4]&&effect[4].match(targetSelf)?(window.console.log("Target self"),damagingS=effect[1]):damagingE=effect[1]);else if(effect[0]&&effect[0].match(destroy)){if(effect[1]&&effect[1].match(one))effect[4]&&effect[4].match(targetSelf)?window.console.log("Target self"):(window.console.log("Destroying one piece"),destroyingE=1);else if(effect[1]&&effect[1].match(every)){window.console.log("Destroy all pieces");var pieces=$(".box.flipper.opened");$(pieces).removeClass("opened"),$(pieces).removeClass("opened-p1"),$(pieces).removeClass("opened-p2");for(var i=0;i<pieces.length;i++)board.results[pieces[i].x][pieces[j].y]=0}}else if(effect[0]&&effect[0].match(draw))if(effect[1]&&effect[1].match(one))eval("player"+playerNo).hand.length<maxHandSize&&eval("player"+playerNo).drawCard();else for(var i=0;i<effect[1];i++)eval("player"+playerNo).hand.length<maxHandSize&&eval("player"+playerNo).drawCard();else if(effect[0]&&effect[0].match(freeze)&&(effect[1]&&effect[1].match(one)&&(window.console.log("Doing a frost... spoopy!"),freezing=1),effect[1]&&effect[1].match(every)))for(var i=0;4>i;i++)for(var j=0;4>j;j++)0===board.results[i][j]&&(board.frost[i][j]=2,$(".box.flipper").addClass("frost"))}window.console.log("DaE: "+damagingE+", DaS: "+damagingS+", DeE: "+destroyingE+", DeS: "+destroyingS+", Sh: "+shielding+", Fr: "+freezing+", Bl: "+blocking),this.cardBody.remove(),delete this},this.createCard=function(e){this.cardBody=jQuery("<div/>",{"class":"card drawn "+this.cardName.toLowerCase().split(" ").join("_")}),jQuery("<div/>",{"class":"cardName",text:this.cardName}).appendTo(this.cardBody),jQuery("<div/>",{"class":"cardEffects",text:this.cardEffects.join([separator=". "])+"."}).appendTo(this.cardBody);var t=this;$(this.cardBody[0]).click(function(){t.playCard(t,e,b)}),$(".p"+e+"-hand:first").append(this.cardBody)}}function Piece(){this.row=-1,this.col=-1,this.shielded=!1}function Player(number){this.playerNo=number,this.deck=[],this.hand=[],this.active=[],this.discard=[],this.pieces=[],this.createDeck=function(){for(var tempDeck=JSON.parse(eval("deck_p"+this.playerNo)),i=0;i<tempDeck.length;i++){var newCard=new Card;newCard.cardName=tempDeck[i];for(var j=0;j<cards.length;j++)cards[j].name===newCard.cardName&&(newCard.cardEffects=cards[j].effects);this.deck.push(newCard)}this.deck=shuffle(this.deck)},this.drawCard=function(){this.deck.length>0&&(this.deck[0].createCard(this.playerNo),this.hand.push(this.deck[0]),this.deck.splice(0,1),$(".hand").append())}}function Board(){this.results=[],this.frost=[],this.rock=[],this.shields=[],this.currentPlayer=0,this.initiateBoard=function(){for(var e=0;4>e;e++){this.results[e]=[],this.frost[e]=[],this.rock[e]=[],this.shields[e]=[];for(var t=0;4>t;t++){var s=4*e+t+1;this.results[e][t]=0,this.frost[e][t]=0,this.rock[e][t]=0,this.shields[e][t]=0}}this.currentPlayer=1},this.endTurn=function(){if(1===this.currentPlayer){this.currentPlayer=-1,$(".wrapper").removeClass("p1-turn"),$(".wrapper").addClass("p2-turn");for(var e=0;e<player1.hand.length;e++)player1.hand[e].cardBody.addClass("hidden");for(var e=0;e<player2.hand.length;e++)player2.hand[e].cardBody.removeClass("hidden");player2.drawCard()}else{this.currentPlayer=1,$(".wrapper").removeClass("p2-turn"),$(".wrapper").addClass("p1-turn");for(var e=0;e<player2.hand.length;e++)player2.hand[e].cardBody.addClass("hidden");for(var e=0;e<player1.hand.length;e++)player1.hand[e].cardBody.removeClass("hidden");player1.drawCard()}for(var t=$(".box.flipper"),e=0;4>e;e++)for(var s=0;4>s;s++)t.x===e&&t.y===s&&t.removeClass("frost"),this.frost[e][s]=this.frost[e][s]>0?this.frost[e][s]-1:0,this.rock[e][s]=this.rock[e][s]>0?this.rock[e][s]-1:0;var r=0,i=0,a=0,o=0,n=0,d=0,l=0},this.updateCell=function(e,t){if(0!==this.results[e][t]||this.frost[e][t]>=1||this.rock[e][t]>=1)window.console.log("The cell is occupied!"),0!==this.results[e][t]?destroyingE>0?this.results[e][t]!==this.currentPlayer&&(board.results[this.getAttribute("x")][this.getAttribute("y")]=0,window.console.log(board.results),$(this).removeClass("opened"),$(this).removeClass("opened-p1"),$(this).removeClass("opened-p2"),destroyingE-=1):destroyingS>0?this.results[e][t]===this.currentPlayer&&(board.results[this.getAttribute("x")][this.getAttribute("y")]=0,window.console.log(board.results),$(this).removeClass("opened"),$(this).removeClass("opened-p1"),$(this).removeClass("opened-p2"),destroyingS-=1):damagingE>0?this.results[e][t]!==this.currentPlayer&&(board.results[this.getAttribute("x")][this.getAttribute("y")]=0,window.console.log(board.results),$(this).removeClass("opened"),$(this).removeClass("opened-p1"),$(this).removeClass("opened-p2"),damagingE-=1):damagingS>0?this.results[e][t]!==this.currentPlayer&&(board.results[this.getAttribute("x")][this.getAttribute("y")]=0,window.console.log(board.results),$(this).removeClass("opened"),$(this).removeClass("opened-p1"),$(this).removeClass("opened-p2"),damagingS-=1):shielding>0&&(shielding-=1):this.frost[e][t]>=1||this.rock[e][t]>=1;else if(freezing>0)2===this.frost[e][t];else if(blocking>0)3===this.rock[e][t];else{var s=new Piece;s.row=e,s.col=t,s.square=$("div").find("[x="+e+"][y="+t+"]"),this.results[e][t]=this.currentPlayer,s.square.addClass("opened flip"),$(s.square).unbind(),1===this.currentPlayer?(s.square.addClass("opened-p1"),$(player1.pieces).append(s)):(s.square.addClass("opened-p2"),$(player2.pieces).append(s)),this.endTurn()}},this.drawMark=function(e){return 1===e?"X":"O"},this.playGame=function(e,t){void 0===this.determineWinner()&&this.updateCell(e,t),this.gameOver()},this.gameOver=function(){var e=this;void 0!==this.determineWinner()&&setTimeout(function(){window.alert("The winner is "+e.drawMark(e.determineWinner()))},100)},this.determineWinner=function(){return void 0!==this.checkRows()?this.checkRows():void 0!==this.checkCols()?this.checkCols():void 0!==this.checkDiagonals()?this.checkDiagonals():void 0},this.checkRows=function(){for(var e=0;4>e;e++){var t=this.results[e][0]+this.results[e][1]+this.results[e][2]+this.results[e][3];if(4===t||-4===t)return this.results[e][0]}},this.checkCols=function(){for(var e=0;4>e;e++){var t=this.results[0][e]+this.results[1][e]+this.results[2][e]+this.results[3][e];if(4===t||-4===t)return this.results[0][e]}},this.checkDiagonals=function(){var e=this.results[0][0]+this.results[1][1]+this.results[2][2]+this.results[3][3];return 4===e||-4===e?this.results[1][1]:(e=this.results[0][3]+this.results[1][2]+this.results[2][1]+this.results[3][0],4===e||-4===e?this.results[1][1]:void 0)}}var startHandSize=2,maxHandSize=10,damagingA=0,damagingE=0,destroyingE=0,damagingA=0,damagingS=0,destroyingS=0,shielding=0,freezing=0,thawing=0,blocking=0,b=new Board;b.initiateBoard();var player1=new Player(1),player2=new Player(2);player1.createDeck(),player2.createDeck();for(var i=0;startHandSize>i;i++)player1.drawCard();for(var i=0;startHandSize>i;i++)player2.drawCard();$(".box").click(function(){var e=this.getAttribute("x"),t=this.getAttribute("y");b.playGame(e,t)}),$("#submitButton").click(function(){location.reload()}),$("#endTurnButton").click(function(){b.endTurn()})});