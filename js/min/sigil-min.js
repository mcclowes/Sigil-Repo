$(function(){function shuffle(e){for(var t,r,i=e.length;i;t=Math.floor(Math.random()*i),r=e[--i],e[i]=e[t],e[t]=r);return e}function Card(){this.cardName="",this.cardEffects=[],this.cardImage="",this.cardBody="",this.playCard=function(targetCard,playerNo,board){window.console.log($(this)),$(this.cardBody).fadeOut(300);for(var deal=new RegExp("deal","i"),destroy=new RegExp("destroy","i"),draw=new RegExp("draw","i"),one=new RegExp("a|1","i"),every=new RegExp("all|every","i"),endTurn=new RegExp("end","i"),targetSelf=new RegExp("your","i"),freeze=new RegExp("freeze","i"),block=new RegExp("block","i"),i=0;i<this.cardEffects.length;i++){window.console.log(this.cardName+" -> "+this.cardEffects[i]);var effect=this.cardEffects[i].split(" ");if(window.console.log(effect),effect[0]&&effect[0].match(endTurn))board.endTurn();else if(effect[0]&&effect[0].match(deal))effect[1]&&effect[1].match(one)?(effect[4]&&effect[4].match(targetSelf)&&window.console.log("Target self"),window.console.log("Doing a DAMAGE effect!"),$(".box.flipper.opened.flip").click(function(){$(".box.flipper").unbind(),board.results[this.getAttribute("x")][this.getAttribute("y")]=0,window.console.log(board.results),$(this).removeClass("opened"),$(this).removeClass("opened-p1"),$(this).removeClass("opened-p2"),$(".box.flipper:not(.opened)").click(function(){var e=this.getAttribute("x"),t=this.getAttribute("y");board.playGame(e,t)})})):effect[1]&&effect[1].match(every);else if(effect[0]&&effect[0].match(destroy)){if(effect[1]&&effect[1].match(one))effect[4]&&effect[4].match(targetSelf)&&window.console.log("Target self"),window.console.log("Destroying one piece"),$(".box.flipper.opened.flip").click(function(){$(".box.flipper").unbind();var e=$(this).children()[0];window.console.log(e),window.console.log(board.results),board.results[e.getAttribute("col")][e.getAttribute("row")]=0,window.console.log(board.results),$(this).removeClass("opened"),$(this).removeClass("opened-p1"),$(this).removeClass("opened-p2"),$(".box.flipper:not(.opened)").click(function(){var e=$(this).children().attr("col"),t=$(this).children().attr("row");board.playGame(t,e)})}),window.console.log($(".box.flipper.opened.flip"));else if(effect[1]&&effect[1].match(every)){window.console.log("Destroy all pieces");var pieces=$(".box.flipper.opened");$(pieces).removeClass("opened"),$(pieces).removeClass("opened-p1"),$(pieces).removeClass("opened-p2");for(var i=0;i<pieces.length;i++)board.results[pieces[i].x][pieces[j].y]=0;$(".box.flipper:not(.opened)").click(function(){var e=this.getAttribute("x"),t=this.getAttribute("y");board.playGame(e,t)})}}else if(effect[0]&&effect[0].match(draw))if(effect[1]&&effect[1].match(one))eval("player"+playerNo).hand.length<maxHandSize&&eval("player"+playerNo).drawCard();else for(var i=0;i<effect[1];i++)eval("player"+playerNo).hand.length<maxHandSize&&eval("player"+playerNo).drawCard();else if(effect[0]&&effect[0].match(freeze)&&(effect[1]&&effect[1].match(one)&&(window.console.log("Doing a frost... spoopy!"),$(".box.flipper:not(.opened)").click(function(){0==board.results[pieceCoords.getAttribute("col")][pieceCoords.getAttribute("row")]&&($(".box.flipper").unbind(),board.frost[pieceCoords.getAttribute("col")][pieceCoords.getAttribute("row")]=2,$(".box.flipper").addClass("frost"),$(".box.flipper:not(.opened)").click(function(){var e=this.getAttribute("x"),t=this.getAttribute("y");board.playGame(e,t)}))})),effect[1]&&effect[1].match(every)))for(var i=0;4>i;i++)for(var j=0;4>j;j++)0===board.results[i][j]&&(board.frost[i][j]=2,$(".box.flipper").addClass("frost"))}this.cardBody.remove(),delete this},this.createCard=function(e){this.cardBody=jQuery("<div/>",{"class":"card drawn "+this.cardName.toLowerCase().split(" ").join("_")}),jQuery("<div/>",{"class":"cardName",text:this.cardName}).appendTo(this.cardBody),jQuery("<div/>",{"class":"cardEffects",text:this.cardEffects.join([separator=". "])+"."}).appendTo(this.cardBody);var t=this;$(this.cardBody[0]).click(function(){t.playCard(t,e,b)}),$(".p"+e+"-hand:first").append(this.cardBody)}}function Piece(){this.row=-1,this.col=-1,this.shieled=!1}function Player(number){this.playerNo=number,this.deck=[],this.hand=[],this.active=[],this.discard=[],this.pieces=[],this.createDeck=function(){for(var tempDeck=JSON.parse(eval("deck_p"+this.playerNo)),i=0;i<tempDeck.length;i++){var newCard=new Card;newCard.cardName=tempDeck[i];for(var j=0;j<cards.length;j++)cards[j].name===newCard.cardName&&(newCard.cardEffects=cards[j].effects);this.deck.push(newCard)}this.deck=shuffle(this.deck)},this.drawCard=function(){this.deck.length>0&&(this.deck[0].createCard(this.playerNo),this.hand.push(this.deck[0]),this.deck.splice(0,1),$(".hand").append())}}function Board(){this.results=[],this.frost=[],this.rock=[],this.shields=[],this.currentPlayer=0,this.initiateBoard=function(){for(var e=0;4>e;e++){this.results[e]=[],this.frost[e]=[],this.rock[e]=[],this.shields[e]=[];for(var t=0;4>t;t++){var r=4*e+t+1;this.results[e][t]=0,this.frost[e][t]=0,this.rock[e][t]=0,this.shields[e][t]=0}}this.currentPlayer=1},this.endTurn=function(){if(1===this.currentPlayer){this.currentPlayer=-1,$(".wrapper").removeClass("p1-turn"),$(".wrapper").addClass("p2-turn");for(var e=0;e<player1.hand.length;e++)player1.hand[e].cardBody.addClass("hidden");for(var e=0;e<player2.hand.length;e++)player2.hand[e].cardBody.removeClass("hidden");player2.drawCard()}else{this.currentPlayer=1,$(".wrapper").removeClass("p2-turn"),$(".wrapper").addClass("p1-turn");for(var e=0;e<player2.hand.length;e++)player2.hand[e].cardBody.addClass("hidden");for(var e=0;e<player1.hand.length;e++)player1.hand[e].cardBody.removeClass("hidden");player1.drawCard()}for(var t=$(".box.flipper"),e=0;4>e;e++)for(var r=0;4>r;r++)t.x===e&&t.y===r&&t.removeClass("frost"),frost[e][r]=frost[e][r]>0?frost[e][r]-1:0,rock[e][r]=rock[e][r]>0?rock[e][r]-1:0},this.updateCell=function(e,t){if(0!==this.results[e][t]||this.frost[e][t]>=1||this.rock[e][t]>=1)window.alert("The cell is occupied!");else{var r=new Piece;r.row=e,r.col=t,r.square=$("div").find("[x="+e+"][y="+t+"]"),this.results[e][t]=this.currentPlayer,r.square.addClass("opened flip"),$(r.square).unbind(),1===this.currentPlayer?(r.square.addClass("opened-p1"),$(player1.pieces).append(r)):(r.square.addClass("opened-p2"),$(player2.pieces).append(r),window.console.log(player2.pieces)),this.endTurn()}},this.drawMark=function(e){return 1===e?"X":"O"},this.playGame=function(e,t){void 0===this.determineWinner()&&this.updateCell(e,t),this.gameOver()},this.gameOver=function(){var e=this;void 0!==this.determineWinner()&&setTimeout(function(){window.alert("The winner is "+e.drawMark(e.determineWinner()))},100)},this.determineWinner=function(){return void 0!==this.checkRows()?this.checkRows():void 0!==this.checkCols()?this.checkCols():void 0!==this.checkDiagonals()?this.checkDiagonals():void 0},this.checkRows=function(){for(var e=0;4>e;e++){var t=this.results[e][0]+this.results[e][1]+this.results[e][2]+this.results[e][3];if(4===t||-4===t)return this.results[e][0]}},this.checkCols=function(){for(var e=0;4>e;e++){var t=this.results[0][e]+this.results[1][e]+this.results[2][e]+this.results[3][e];if(4===t||-4===t)return this.results[0][e]}},this.checkDiagonals=function(){var e=this.results[0][0]+this.results[1][1]+this.results[2][2]+this.results[3][3];return 4===e||-4===e?this.results[1][1]:(e=this.results[0][3]+this.results[1][2]+this.results[2][1]+this.results[3][0],4===e||-4===e?this.results[1][1]:void 0)}}var startHandSize=2,maxHandSize=10,b=new Board;b.initiateBoard();var player1=new Player(1),player2=new Player(2);player1.createDeck(),player2.createDeck();for(var i=0;startHandSize>i;i++)player1.drawCard();for(var i=0;startHandSize>i;i++)player2.drawCard();$(".box").click(function(){var e=this.getAttribute("x"),t=this.getAttribute("y");b.playGame(e,t)}),$("#submitButton").click(function(){location.reload()}),$("#endTurnButton").click(function(){b.endTurn()})});